#!/bin/busybox sh
set -eux

# 0. directories the kernel doesn't create for us
mkdir -p /proc /sys /dev

# 1. (optional) only if you want links in /bin at boot
#/bin/busybox --install -s -busyboxdir=/bin

export PATH=/bin:/sbin

# 2. mount pseudoâ€‘filesystems
mount -t devtmpfs devtmpfs /dev
mount -t proc      proc      /proc
mount -t sysfs     sysfs     /sys

mkdir -p /dev/pts /dev/shm
mount -t devpts    devpts    /dev/pts
mount -t tmpfs     shm       /dev/shm

# 3. handle cmdline
ROOT_TAG=rootfs
VSOCK_PORT=1024
for a in $(cat /proc/cmdline); do
    case $a in
        root_tag=*)  ROOT_TAG=${a#root_tag=} ;;
        vsock_port=*) VSOCK_PORT=${a#vsock_port=} ;;
    esac
done

# 4. switch to the real root and launch your agent
mkdir -p /newroot
mount -t virtiofs "$ROOT_TAG" /newroot
exec switch_root /newroot /usr/bin/guest_agent --vsock-port="$VSOCK_PORT"